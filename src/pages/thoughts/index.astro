---
import { getCollection } from "astro:content";
import AppShell from "../../components/AppShell.astro";
import PostListItem from "../../components/PostListItem.astro";

const thoughts = await getCollection("thoughts");

// Filter out drafts and sort by date
const publishedThoughts = thoughts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Get unique categories
const categories = [
  "All",
  ...new Set(publishedThoughts.map((post) => post.data.category)),
];

// Get current filter from URL
const url = new URL(Astro.request.url);
const currentFilter = url.searchParams.get("category") || "All";

// Filter posts based on category
const filteredThoughts =
  currentFilter === "All"
    ? publishedThoughts
    : publishedThoughts.filter((post) => post.data.category === currentFilter);
---

<AppShell
  title="Thoughts"
  description="Writing about technology, life, and lessons learned along the way."
>
  <div class="mb-8">
    <h1 class="text-3xl md:text-4xl font-bold text-heading mb-4">Thoughts</h1>
    <p class="text-lg text-text leading-relaxed max-w-2xl">
      Writing about technology, life, and lessons learned along the way.
      Sometimes technical, sometimes personal, always honest.
    </p>
  </div>

  <!-- Category Filter -->
  <div class="mb-8">
    <div class="flex flex-wrap gap-2">
      {
        categories.map((category) => {
          const isActive = currentFilter === category;
          const href =
            category === "All" ? "/thoughts" : `/thoughts?category=${category}`;

          return (
            <a
              href={href}
              class={`px-4 py-2 rounded-lg font-medium transition-colors ${
                isActive
                  ? "bg-accent/10 text-accent"
                  : "bg-muted/10 text-muted hover:bg-muted/20 hover:text-text"
              }`}
            >
              {category}
            </a>
          );
        })
      }
    </div>
  </div>

  <!-- Posts List -->
  {
    filteredThoughts.length > 0 ? (
      <div class="space-y-0">
        {filteredThoughts.map((post) => (
          <PostListItem
            title={post.data.title}
            href={`/thoughts/${post.slug}`}
            date={post.data.date}
            category={post.data.category}
            summary={post.data.summary}
          />
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <p class="text-muted">
          {currentFilter === "All"
            ? "No posts yet. Check back soon!"
            : `No posts in the "${currentFilter}" category yet.`}
        </p>
      </div>
    )
  }
</AppShell>

